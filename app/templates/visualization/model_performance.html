{% extends 'base.html' %}

{% block title %}Model Performance - Prosperity Analysis{% endblock %}

{% block extra_js %}
<!-- Add Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-submit form when dropdowns change
        const modelTypeSelect = document.getElementById('model_type');
        const evaluationYearSelect = document.getElementById('evaluation_year');
        
        if (modelTypeSelect) {
            modelTypeSelect.addEventListener('change', function() {
                document.getElementById('performance-form').submit();
            });
        }
        
        if (evaluationYearSelect) {
            evaluationYearSelect.addEventListener('change', function() {
                document.getElementById('performance-form').submit();
            });
        }
        
        {% if confusion_matrix_json %}
        var confusionData = {{ confusion_matrix_json|safe }};
        Plotly.newPlot('confusion-matrix-plot', confusionData);
        {% endif %}
        
        {% if feature_importance_json %}
        var featureData = {{ feature_importance_json|safe }};
        Plotly.newPlot('feature-importance-plot', featureData);
        {% endif %}
        
    });
</script>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Model Performance Comparison</h4>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('visualization.model_performance') }}" id="performance-form">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="model_type" class="form-label">Model Type</label>
                        <select class="form-select" id="model_type" name="model_type">
                            <option value="random_forest" {% if model_type == 'random_forest' %}selected{% endif %}>Random Forest</option>
                            <option value="logistic_regression" {% if model_type == 'logistic_regression' %}selected{% endif %}>Logistic Regression</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="evaluation_year" class="form-label">Evaluation Year</label>
                        <select class="form-select" id="evaluation_year" name="evaluation_year">
                            <option value="all" {% if evaluation_year == 'all' %}selected{% endif %}>All Years</option>
                            {% for y in range(2019, 2024) %}
                            <option value="{{ y }}" {% if y|string == evaluation_year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

{% if metrics %}
<!-- Performance Metrics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">Performance Metrics - {{ model_type|replace('_', ' ')|title }} 
                    {% if evaluation_year != 'all' %}({{ evaluation_year }}){% else %}(All Years){% endif %}
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center">
                                <h5 class="card-title">Accuracy</h5>
                                <h2 class="display-4">{{ "%.2f"|format(metrics.accuracy * 100) }}%</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center">
                                <h5 class="card-title">Precision</h5>
                                <h2 class="display-4">{{ "%.2f"|format(metrics.precision * 100) }}%</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center">
                                <h5 class="card-title">Recall</h5>
                                <h2 class="display-4">{{ "%.2f"|format(metrics.recall * 100) }}%</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center">
                                <h5 class="card-title">F1 Score</h5>
                                <h2 class="display-4">
                                    {% if metrics.f1_score is defined and metrics.f1_score is not none %}
                                        {{ "%.2f"|format(metrics.f1_score * 100) }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </h2>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center">
                                <h5 class="card-title">Training Time</h5>
                                <h2 class="display-4">{{ "%.2f"|format(metrics.training_time) }} s</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center">
                                <h5 class="card-title">Inference Time</h5>
                                <h2 class="display-4">
                                    {% if metrics.inference_time is defined and metrics.inference_time is not none %}
                                        {{ "%.4f"|format(metrics.inference_time * 1000) }} ms
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Visualizations -->
<div class="row">
    <!-- Confusion Matrix -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">Confusion Matrix {% if evaluation_year != 'all' %}({{ evaluation_year }}){% endif %}</h4>
            </div>
            <div class="card-body d-flex justify-content-center">
                {% if confusion_matrix_json %}
                <div id="confusion-matrix-plot" style="width: 100%; min-height: 450px;"></div>
                {% else %}
                <div class="alert alert-warning">
                    No confusion matrix data available.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
  <!-- Feature Importance -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">Feature Importance</h4>
            </div>
            <div class="card-body d-flex justify-content-center">
                {% if feature_importance_json %}
                <div id="feature-importance-plot" style="width: 100%; min-height: 500px;"></div>
                {% else %}
                <div class="alert alert-warning">
                    No feature importance data available.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- No Model Data Available -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-warning text-dark">
        <h4 class="mb-0">No Model Data Available</h4>
      </div>
      <div class="card-body">
        <p class="lead">
          There are no models trained yet. You need to train a model to view performance metrics and visualizations.
        </p>
        {% if current_user.is_admin %}
        <div class="text-center">
          <a
            href="{{ url_for('dataset.train_models') }}"
            class="btn btn-primary"
          >
            <i class="fas fa-cogs me-2"></i> Train Models
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
